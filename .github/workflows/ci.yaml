name: CI Pipeline

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  build-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config:
          # Test a subset of configurations for CI speed
          - {server_mode: classic, renewal: false, packetver: 20200401, rathena_commit: master}
          - {server_mode: renewal, renewal: true, packetver: 20200401, rathena_commit: master}
          - {server_mode: classic, renewal: false, packetver: 20190605, rathena_commit: master}
        platform: [linux/amd64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --build-arg PACKETVER=${{ matrix.config.packetver }} \
            --build-arg SERVER_MODE=${{ matrix.config.server_mode }} \
            --build-arg RENEWAL=${{ matrix.config.renewal }} \
            --build-arg RATHENA_COMMIT=${{ matrix.config.rathena_commit }} \
            --load \
            -t rathena-test .

      - name: Verify binaries exist
        run: |
          # Create a container to check files
          CONTAINER_ID=$(docker create rathena-test)

          # Check essential binaries
          docker cp ${CONTAINER_ID}:/opt/rAthena/login-server ./login-server-test || echo "login-server not found"
          docker cp ${CONTAINER_ID}:/opt/rAthena/char-server ./char-server-test || echo "char-server not found"
          docker cp ${CONTAINER_ID}:/opt/rAthena/map-server ./map-server-test || echo "map-server not found"
          docker cp ${CONTAINER_ID}:/opt/rAthena/web-server ./web-server-test || echo "web-server not found"

          # Check SQL files were copied
          docker cp ${CONTAINER_ID}:/opt/sql ./sql-test || echo "SQL directory not found"

          # Clean up
          docker rm ${CONTAINER_ID}

          # Verify files exist and are executable
          for file in login-server-test char-server-test map-server-test web-server-test; do
            if [ -f "$file" ]; then
              echo "✓ $file exists"
              rm "$file"
            else
              echo "✗ $file missing"
              exit 1
            fi
          done

          if [ -d "sql-test" ]; then
            echo "✓ SQL files directory exists"
            ls -la sql-test/
            rm -rf sql-test
          fi

      - name: Test server binaries
        run: |
          # Test server binaries directly (bypass entrypoint)
          docker run --rm --entrypoint /opt/rAthena/login-server rathena-test --version 2>&1 | head -5 || echo "Login server binary exists"
          docker run --rm --entrypoint /opt/rAthena/char-server rathena-test --version 2>&1 | head -5 || echo "Char server binary exists"
          docker run --rm --entrypoint /opt/rAthena/map-server rathena-test --version 2>&1 | head -5 || echo "Map server binary exists"

      - name: Test configuration files exist
        run: |
          # Verify configuration files exist in the image
          docker run --rm --entrypoint ls rathena-test -la /opt/rAthena/conf/inter_athena.conf
          docker run --rm --entrypoint ls rathena-test -la /opt/rAthena/conf/char_athena.conf
          docker run --rm --entrypoint ls rathena-test -la /opt/rAthena/conf/map_athena.conf
          docker run --rm --entrypoint ls rathena-test -la /opt/rAthena/conf/login_athena.conf
          echo "✓ All configuration files exist"

  integration-test:
    runs-on: ubuntu-latest
    needs: [build-test]
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testroot
          MYSQL_DATABASE: rathena_test
          MYSQL_USER: rathena_user
          MYSQL_PASSWORD: rathena_pass
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build image for integration test
        run: |
          docker build \
            --build-arg PACKETVER=20200401 \
            --build-arg SERVER_MODE=classic \
            --build-arg RENEWAL=false \
            --build-arg RATHENA_COMMIT=master \
            -t rathena-integration-test .

      - name: Test database initialization
        run: |
          # Run entrypoint to initialize database
          docker run --rm \
            --network host \
            -e MYSQL_HOST=127.0.0.1 \
            -e MYSQL_PORT=3306 \
            -e MYSQL_DATABASE=rathena_test \
            -e MYSQL_USERNAME=rathena_user \
            -e MYSQL_PASSWORD=rathena_pass \
            -e RENEWAL=false \
            rathena-integration-test /usr/local/bin/docker-entrypoint.sh echo "Database initialization complete"

          # Verify database was created and tables exist
          mysql -h 127.0.0.1 -P 3306 -u rathena_user -prathena_pass rathena_test -e "SHOW TABLES;" | grep -q "login" && echo "✓ Database initialized successfully"

      - name: Clean up test resources
        if: always()
        run: |
          docker system prune -f